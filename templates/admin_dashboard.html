<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .content-box {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 15px;
      position: relative;
    }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      margin: 5px 0 10px;
      box-sizing: border-box;
      padding: 8px;
    }
    .add-button {
      margin-bottom: 10px;
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    .section {
      margin-bottom: 30px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    img.preview-img {
      max-width: 100%;
      margin-top: 10px;
      max-height: 150px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .status-message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    button {
      padding: 6px 12px;
      margin-right: 5px;
      cursor: pointer;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .form-row {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <div class="section">
    <h2>Overview</h2>
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
      <div class="content-box" style="flex: 1; min-width: 200px;">
        <h3>Total Videos</h3>
        <p><strong id="total-videos">Loading...</strong></p>
      </div>
      <div class="content-box" style="flex: 1; min-width: 200px;">
        <h3>Active Users</h3>
        <p><strong id="active-users">Loading...</strong></p>
      </div>
      <div class="content-box" style="flex: 1; min-width: 200px;">
        <h3>Reports</h3>
        <p><strong id="report-count">Loading...</strong></p>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>Recent Uploads</h2>
    <div id="recent-uploads"></div>
  </div>

  <div class="section" id="dashboards-section">
    <h2>Dashboards</h2>
    <button class="add-button" onclick="addItem('dashboards')">Add Dashboard</button>
    <div id="dashboards-content"></div>
  </div>

  <div class="section" id="images-section">
    <h2>Images</h2>
    <form id="image-upload-form">
      <div class="form-row">
        <label for="image-title">Title:</label>
        <input type="text" id="image-title" name="title" required />
      </div>
      <div class="form-row">
        <label for="image-description">Description:</label>
        <textarea id="image-description" name="description"></textarea>
      </div>
      <div class="form-row">
        <label for="image-url">Image URL:</label>
        <input type="text" id="image-url" name="image_url" required />
        <img id="image-preview" class="preview-img" style="display:none;" />
      </div>
      <button type="submit">Upload Image</button>
      <div id="image-status" class="status-message"></div>
    </form>
    <div id="images-content"></div>
  </div>

  <div class="section" id="music-section">
    <h2>Music</h2>
    <button class="add-button" onclick="addItem('music')">Add Music</button>
    <div id="music-content"></div>
  </div>

  <div class="section" id="videos-section">
    <h2>Videos</h2>
    <button class="add-button" onclick="addVideoItem()">Add Video</button>
    <div id="videos-content"></div>
  </div>

  <div class="section" id="youtube-section">
    <h2>Live Videos</h2>
    <button class="add-button" onclick="addYouTubeItem()">Add YouTube Video</button>
    <div id="youtube-content"></div>
  </div>

  <div class="section" id="inbox-section">
    <h2>Inbox</h2>
    <button class="add-button" onclick="addItem('inbox')">Add Inbox Message</button>
    <div id="inbox-content"></div>
  </div>

  <div class="section" id="products-section">
    <h2>Products</h2>
    <button class="add-button" onclick="addItem('products')">Add Product</button>
    <div id="products-content"></div>
  </div>

  <script>
    // Utility Functions
    function extractYouTubeVideoId(url) {
      const patterns = [
        /(?:youtube\.com\/.*v=|youtu\.be\/|youtube\.com\/shorts\/)([^\"&?\/"]{11})/, 
        /^([^\"&?\/"]{11})$/
      ];
      for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) return match[1];
      }
      return null;
    }

    function updateImagePreview() {
      const url = document.getElementById('image-url').value.trim();
      const preview = document.getElementById('image-preview');
      if (url) {
        preview.src = url;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }

    function showStatus(element, message, isSuccess) {
      element.textContent = message;
      element.className = isSuccess ? 'status-message success' : 'status-message error';
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    // Image Upload Handler
    document.getElementById('image-upload-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const statusDiv = document.getElementById('image-status');
      const submitButton = form.querySelector('button[type="submit"]');
      
      submitButton.disabled = true;
      statusDiv.textContent = "Uploading image...";
      statusDiv.className = 'status-message';
      statusDiv.style.display = 'block';

      try {
        const title = document.getElementById('image-title').value.trim();
        const description = document.getElementById('image-description').value.trim();
        const imageUrl = document.getElementById('image-url').value.trim();

        if (!title) throw new Error("Title is required");
        if (!imageUrl) throw new Error("Image URL is required");

        const response = await fetch('/admin/add_images_item', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            title: title,
            description: description,
            image_url: imageUrl
          })
        });

        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || "Failed to upload image");
        }

        showStatus(statusDiv, 'Image uploaded successfully!', true);
        form.reset();
        document.getElementById('image-preview').style.display = 'none';
        loadSection('images');
      } catch (error) {
        showStatus(statusDiv, `Error: ${error.message}`, false);
        console.error('Image upload error:', error);
      } finally {
        submitButton.disabled = false;
      }
    });

    // CRUD Operations
    function createNewBox(section) {
      const container = document.getElementById(`${section}-content`);
      const box = document.createElement("div");
      box.className = "content-box";
      
      let contentFields = '';
      const statusDiv = document.createElement('div');
      statusDiv.className = 'status-message';
      box.appendChild(statusDiv);

      if (section === 'inbox') {
        contentFields = `
          <div class="form-row">
            <label>Message:</label>
            <textarea class="message" placeholder="Enter message..." required></textarea>
          </div>
          <div class="form-row">
            <label>Section:</label>
            <input type="text" class="section" placeholder="Enter section" required />
          </div>
          <button onclick="saveItem(this, '${section}')">Save</button>
          <button onclick="removeUnsavedItem(this)">Cancel</button>`;
      } else if (section === 'products') {
        contentFields = `
          <div class="form-row">
            <label>Image URL:</label>
            <input type="text" class="image_url" placeholder="Image URL" oninput="updateImagePreview(this)" />
            <img class="preview-img" style="display:none;" />
          </div>
          <div class="form-row">
            <label>Product Name:</label>
            <input type="text" class="name" placeholder="Enter product name" required />
          </div>
          <div class="form-row">
            <label>Price:</label>
            <input type="number" step="0.01" min="0" class="price" placeholder="Enter price" required />
          </div>
          <div class="form-row">
            <label>Description:</label>
            <textarea class="description" placeholder="Enter description..."></textarea>
          </div>
          <button onclick="saveProductItem(this)">Save</button>
          <button onclick="removeUnsavedItem(this)">Cancel</button>`;
      } else {
        if (["dashboards", "music"].includes(section)) {
          contentFields += `
            <div class="form-row">
              <label>Image URL:</label>
              <input type="text" class="image_url" placeholder="Image URL" oninput="updateImagePreview(this)" />
              <img class="preview-img" style="display:none;" />
            </div>`;
        }
        contentFields += `
          <div class="form-row">
            <label>Item Link:</label>
            <input type="text" class="link" placeholder="Link (optional)" />
          </div>
          <div class="form-row">
            <label>Item Title:</label>
            <input type="text" class="title" placeholder="Enter title" required />
          </div>
          <div class="form-row">
            <label>Description:</label>
            <textarea class="description" placeholder="Enter description..." required></textarea>
          </div>
          <button onclick="saveItem(this, '${section}')">Save</button>
          <button onclick="removeUnsavedItem(this)">Cancel</button>`;
      }

      box.innerHTML += contentFields;
      container.appendChild(box);
    }

    async function saveItem(button, section) {
      const box = button.parentElement;
      const statusDiv = box.querySelector('.status-message');
      box.classList.add('loading');
      const buttons = box.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);

      try {
        const data = {};
        if (section === 'inbox') {
          data.message = box.querySelector('.message').value.trim();
          data.section = box.querySelector('.section').value.trim();
          
          if (!data.message || !data.section) {
            throw new Error("Message and section are required");
          }
        } else {
          box.querySelectorAll('input, textarea').forEach(field => {
            data[field.className] = field.value.trim();
          });

          if (section === 'products') {
            if (!data.name || !data.price) throw new Error("Product name and price are required");
            if (isNaN(data.price)) throw new Error("Price must be a number");
          } else {
            if (!data.title || !data.description) throw new Error("Title and description are required");
          }
        }

        const response = await fetch(`/admin/add_${section}_item`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || "Failed to save item");
        }

        showStatus(statusDiv, `${section} item saved successfully!`, true);
        setTimeout(() => loadSection(section), 1000);
      } catch (error) {
        showStatus(statusDiv, `Error: ${error.message}`, false);
        console.error('Save error:', error);
      } finally {
        box.classList.remove('loading');
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    async function saveProductItem(button) {
      const box = button.parentElement;
      const statusDiv = box.querySelector('.status-message') || document.getElementById('products-status');
      box.classList.add('loading');
      const buttons = box.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);

      try {
        const data = {
          name: box.querySelector('.name').value.trim(),
          price: parseFloat(box.querySelector('.price').value.trim()),
          description: box.querySelector('.description').value.trim(),
          image_url: box.querySelector('.image_url').value.trim()
        };

        if (!data.name || isNaN(data.price)) {
          throw new Error("Valid product name and price are required");
        }

        const response = await fetch('/admin/add_products_item', {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || "Failed to save product");
        }

        showStatus(statusDiv, "Product saved successfully!", true);
        setTimeout(() => loadSection('products'), 1000);
      } catch (error) {
        showStatus(statusDiv, `Error: ${error.message}`, false);
        console.error('Save product error:', error);
      } finally {
        box.classList.remove('loading');
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    async function deleteItem(section, id) {
      if (!confirm(`Are you sure you want to delete this ${section} item?`)) return;
      
      try {
        const response = await fetch(`/admin/delete_${section}_item/${id}`, { 
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || "Failed to delete item");
        }
        
        document.querySelector(`.content-box[data-id="${id}"]`)?.remove();
        showStatus(document.getElementById(`${section}-status`), 
                 `${section} item deleted successfully`, true);
      } catch (error) {
        showStatus(document.getElementById(`${section}-status`), 
                 `Failed to delete: ${error.message}`, false);
        console.error('Delete error:', error);
      }
    }

    async function loadSection(section) {
      try {
        const container = document.getElementById(`${section}-content`);
        container.innerHTML = '<p>Loading...</p>';
        
        const response = await fetch(`/admin/get_${section}`);
        if (!response.ok) throw new Error("Failed to load data");
        
        const data = await response.json();
        const items = Array.isArray(data) ? data : data[section] || [];

        if (items.length === 0) {
          container.innerHTML = `<p>No ${section} items found</p>`;
          return;
        }

        container.innerHTML = '';
        
        if (section === 'inbox') {
          const table = document.createElement('table');
          table.innerHTML = `
            <thead>
              <tr>
                <th>Section</th>
                <th>Message</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(item => `
                <tr>
                  <td>${item.section}</td>
                  <td>${item.message}</td>
                  <td>${item.created_at ? new Date(item.created_at).toLocaleString() : ''}</td>
                  <td><button onclick="deleteItem('inbox', ${item.id})">Delete</button></td>
                </tr>
              `).join('')}
            </tbody>`;
          container.appendChild(table);
        } else {
          items.forEach(item => {
            const box = document.createElement("div");
            box.className = "content-box";
            box.setAttribute("data-id", item.id);

            let content = '';
            if (section === 'products') {
              content = `
                <p><strong>Name:</strong> ${item.name}</p>
                <p><strong>Price:</strong> $${item.price?.toFixed(2) || '0.00'}</p>
                ${item.description ? `<p><strong>Description:</strong> ${item.description}</p>` : ""}
                ${item.image_url ? `<img src="${item.image_url}" class="preview-img" />` : ""}
              `;
            } else {
              content = `
                <p><strong>Title:</strong> ${item.title}</p>
                ${item.description ? `<p><strong>Description:</strong> ${item.description}</p>` : ""}
                ${item.image_url || item.url ? `<img src="${item.image_url || item.url}" class="preview-img" />` : ""}
              `;
            }
            
            content += `<button onclick="deleteItem('${section}', ${item.id})">Remove</button>`;
            box.innerHTML = content;
            container.appendChild(box);
          });
        }
      } catch (error) {
        console.error(`Error loading ${section}:`, error);
        document.getElementById(`${section}-content`).innerHTML = 
          `<p class="error-message">Error loading ${section} items: ${error.message}</p>`;
      }
    }

    async function loadDashboardMetrics() {
      try {
        const response = await fetch('/admin/get_dashboard_metrics');
        const data = await response.json();
        
        document.getElementById('total-videos').innerText = data.total_videos || 0;
        document.getElementById('active-users').innerText = data.active_users || 0;
        document.getElementById('report-count').innerText = data.reports || 0;
      } catch (error) {
        console.error('Error loading dashboard metrics:', error);
        document.getElementById('total-videos').innerText = 'Error';
        document.getElementById('active-users').innerText = 'Error';
        document.getElementById('report-count').innerText = 'Error';
      }
    }

    async function loadRecentUploads() {
      try {
        const container = document.getElementById('recent-uploads');
        container.innerHTML = '<p>Loading recent uploads...</p>';
        
        const response = await fetch('/admin/get_recent_uploads');
        const data = await response.json();
        
        if (!data.videos || data.videos.length === 0) {
          container.innerHTML = '<p>No recent uploads.</p>';
          return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr><th>Title</th><th>Uploader</th><th>Date</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${data.videos.map(video => `
              <tr>
                <td>${video.title}</td>
                <td>${video.uploader}</td>
                <td>${video.date}</td>
                <td><button onclick="window.open('/watch/${video.id}', '_blank')">Watch</button></td>
              </tr>`).join('')}
          </tbody>
        `;
        container.innerHTML = '';
        container.appendChild(table);
      } catch (error) {
        console.error('Error loading recent uploads:', error);
        document.getElementById('recent-uploads').innerHTML = 
          '<p class="error-message">Error loading recent uploads</p>';
      }
    }

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', () => {
      ['dashboards', 'images', 'music', 'videos', 'youtube', 'inbox', 'products'].forEach(loadSection);
      loadDashboardMetrics();
      loadRecentUploads();
      
      // Initialize image URL preview
      document.getElementById('image-url').addEventListener('input', updateImagePreview);
    });

    // Public functions
    window.addItem = createNewBox;
    window.addVideoItem = function() { createNewBox('videos'); };
    window.addYouTubeItem = function() { createNewBox('youtube'); };
    window.saveItem = saveItem;
    window.saveProductItem = saveProductItem;
    window.deleteItem = deleteItem;
    window.removeUnsavedItem = function(button) {
      button.closest(".content-box").remove();
    };
    window.updateImagePreview = updateImagePreview;
  </script>
</body>
</html>